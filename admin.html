<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        body {
            background: #121212;
            color: #fff;
            font-family: Arial, sans-serif;
        }
        .container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 20px;
            background: rgba(20, 20, 40, 0.95);
            border-radius: 12px;
            box-shadow: 0 0 20px rgba(0, 255, 247, 0.3);
        }
        .titulo {
            color: #00fff7;
            text-align: center;
            margin-bottom: 30px;
        }
        .btn-menu {
            display: inline-block;
            padding: 10px 20px;
            margin: 10px 0;
            background: linear-gradient(90deg, #00fff7, #1a2980);
            color: #222;
            font-weight: bold;
            text-align: center;
            border-radius: 7px;
            text-decoration: none;
            transition: background 0.3s;
        }
        .btn-menu:hover {
            background: linear-gradient(90deg, #1a2980, #00fff7);
        }
        .admin-panel {
            margin-top: 20px;
        }
        .admin-info {
            margin: 20px 0;
        }
        .admin-lista {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 5px;
            min-height: 40px;
        }
        .admin-total {
            font-size: 1.2em;
            font-weight: bold;
        }
        .btn-warn {
            background: linear-gradient(90deg, #ffcc00, #ff6600);
        }
        .btn-warn:hover {
            background: linear-gradient(90deg, #ff6600, #ffcc00);
        }
        .btn-danger {
            background: linear-gradient(90deg, #ff0033, #660000);
        }
        .btn-danger:hover {
            background: linear-gradient(90deg, #660000, #ff0033);
        }
        .tasa-form {
            margin-top: 20px;
        }
        .tasa-form label {
            display: block;
            margin-bottom: 5px;
        }
        .tasa-form input {
            padding: 10px;
            width: calc(100% - 22px);
            margin-bottom: 10px;
            border: 1px solid #333;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }
        .tasa-form button {
            width: 100%;
        }
        .tasa-ayuda {
            font-size: 0.9em;
            color: #ffcc00;
            margin-top: 5px;
        }
        .admin-compras {
            margin-top: 30px;
        }
        .compra-pendiente {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        .compra-pendiente b {
            color: #00fff7;
        }
        .modal-img-bg {
            display:none;position:fixed;z-index:1000;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.85);justify-content:center;align-items:center;
        }
        .modal-img-bg.active {display:flex;}
        .modal-img-bg img {max-width:90vw;max-height:90vh;border-radius:12px;box-shadow:0 0 24px #00fff7;}
        .modal-img-bg .cerrar-modal {position:absolute;top:30px;right:50px;font-size:2.5em;color:#00fff7;cursor:pointer;user-select:none;}
    </style>
</head>
<body>
    <div class="container">
        <h1 class="titulo">Panel de Administración</h1>
        <div id="adminPanel" class="admin-panel">
            <button class="btn-menu" id="actualizarBtn">Actualizar Datos</button>
            <button class="btn-menu btn-warn" id="cerrarVentaBtn">Cerrar venta de boletos</button>
            <button class="btn-menu btn-danger" id="reiniciarRifaBtn">Reiniciar rifas</button>
            <button class="btn-menu" id="exportarHistorialBtn" style="float:right;margin-bottom:18px;background:linear-gradient(90deg,#FFD700,#B8860B);color:#222;">Exportar historial CSV</button>
            <div class="admin-info">
                <h2>Números Vendidos</h2>
                <div id="numerosVendidos" class="admin-lista"></div>
                <h2>Total Recaudado</h2>
                <div id="totalRecaudado" class="admin-total"></div>
                <h2>Tasa BCV actual</h2>
                <div id="tasaActual" class="admin-tasa"></div>
                <h2>Precio actual en Bs</h2>
                <div id="precioBs" class="admin-precio"></div>
                <form id="formTasa" class="tasa-form">
                    <label for="nuevaTasa">Actualizar tasa BCV manualmente:</label>
                    <input type="number" id="nuevaTasa" step="0.01" min="0" required>
                    <button type="submit" class="btn-menu">Actualizar Tasa</button>
                    <div class="tasa-ayuda">Solo use esta opción si recibe una alerta de error de actualización automática en su correo.</div>
                </form>
                <h2>Revisión de Compras Pendientes</h2>
                <div id="comprasPendientes" class="admin-compras"></div>
                <h2 style="margin-top:32px;">Historial de Compras Confirmadas</h2>
                <div id="comprasConfirmadas" class="admin-compras"></div>
            </div>
        </div>
        <a href="index.html" class="btn-menu volver">Volver al Menú</a>
    </div>
    <div class="modal-img-bg" id="modalImg">
        <span class="cerrar-modal" id="cerrarModal">&times;</span>
        <img id="imgModal" src="" alt="Comprobante grande">
    </div>
    <script>
    let tasaActual = 0;
    function mostrarPrecioBs() {
        const precioUSD = 5;
        if (tasaActual > 0) {
            const precioBs = (precioUSD * tasaActual).toLocaleString('es-VE', {style:'currency', currency:'VES', maximumFractionDigits:2});
            document.getElementById('precioBs').innerHTML = `<b>${precioBs} Bs</b> por boleto`;
        } else {
            document.getElementById('precioBs').innerHTML = '<span style="color:red">No disponible</span>';
        }
    }
    async function cargarDatosAdmin() {
        try {
            const res = await fetch('https://rifasvenezuela.onrender.com/api/numeros-vendidos');
            const vendidos = await res.json();
            document.getElementById('numerosVendidos').textContent = vendidos.length > 0 ? vendidos.sort((a,b)=>a-b).join(', ') : 'Ninguno';
            document.getElementById('totalRecaudado').textContent = '$' + (vendidos.length * 5);
        } catch {
            document.getElementById('numerosVendidos').textContent = 'Error al cargar.';
            document.getElementById('totalRecaudado').textContent = 'Error';
        }
        // Consultar tasa actual
        try {
            const res = await fetch('https://rifasvenezuela.onrender.com/api/tasa-bcv');
            const data = await res.json();
            // Compatibilidad con backend: puede ser data.tasaBCV o data.tasa
            tasaActual = data.tasaBCV || data.tasa || 0;
            document.getElementById('tasaActual').textContent = tasaActual ? tasaActual + ' Bs/USD' : 'No disponible';
        } catch {
            tasaActual = 0;
            document.getElementById('tasaActual').textContent = 'Error al consultar tasa.';
        }
        mostrarPrecioBs();
        // Cargar compras pendientes
        cargarComprasPendientes();
    }
    document.getElementById('actualizarBtn').addEventListener('click', cargarDatosAdmin);
    cargarDatosAdmin();

    document.getElementById('cerrarVentaBtn').addEventListener('click', async function() {
        if (!confirm('¿Seguro que deseas cerrar la venta de boletos? Esta acción es reversible solo reiniciando la rifa.')) return;
        try {
            const res = await fetch('https://rifasvenezuela.onrender.com/api/cerrar-venta', {method:'POST'});
            if (res.ok) {
                alert('Venta de boletos cerrada.');
            } else {
                alert('Error al cerrar la venta.');
            }
        } catch {
            alert('Error de conexión al cerrar la venta.');
        }
    });
    document.getElementById('reiniciarRifaBtn').addEventListener('click', async function() {
        if (!confirm('¿Seguro que deseas reiniciar la rifa? Esta acción eliminará todos los boletos vendidos.')) return;
        try {
            const res = await fetch('https://rifasvenezuela.onrender.com/api/reiniciar-rifa', {method:'POST'});
            if (res.ok) {
                alert('Rifa reiniciada.');
                cargarDatosAdmin();
            } else {
                alert('Error al reiniciar la rifa.');
            }
        } catch {
            alert('Error de conexión al reiniciar la rifa.');
        }
    });
    // Actualizar tasa manualmente
    document.getElementById('formTasa').addEventListener('submit', async function(e) {
        e.preventDefault();
        const nuevaTasa = parseFloat(document.getElementById('nuevaTasa').value);
        if (!nuevaTasa || nuevaTasa <= 0) {
            alert('Ingrese una tasa válida.');
            return;
        }
        if (!confirm('¿Actualizar la tasa BCV a ' + nuevaTasa + ' Bs/USD?')) return;
        try {
            const res = await fetch('https://rifasvenezuela.onrender.com/api/tasa-bcv', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({tasa: nuevaTasa})
            });
            if (res.ok) {
                alert('Tasa actualizada correctamente.');
                cargarDatosAdmin();
            } else {
                alert('Error al actualizar la tasa.');
            }
        } catch {
            alert('Error de conexión al actualizar la tasa.');
        }
    });
    // Compras pendientes
    async function cargarComprasPendientes() {
        const cont = document.getElementById('comprasPendientes');
        const contConfirmadas = document.getElementById('comprasConfirmadas');
        cont.innerHTML = 'Cargando...';
        contConfirmadas.innerHTML = 'Cargando...';
        try {
            const res = await fetch('https://rifasvenezuela.onrender.com/api/compras');
            const compras = await res.json();
            // Filtrar compras
            const pendientes = Array.isArray(compras) ? compras.map((c,i)=>({...c,_id:i})).filter(c => c.estado === 'pendiente') : [];
            const confirmadas = Array.isArray(compras) ? compras.map((c,i)=>({...c,_id:i})).filter(c => c.estado === 'confirmado') : [];
            // Pendientes
            if (pendientes.length === 0) {
                cont.innerHTML = '<span style="color:gray">No hay compras pendientes.</span>';
            } else {
                cont.innerHTML = '';
                pendientes.forEach(compra => {
                    const div = document.createElement('div');
                    div.className = 'compra-pendiente';
                    let comprobanteHtml = '';
                    if (compra.comprobante) {
                        const url = `https://rifasvenezuela.onrender.com/uploads/${compra.comprobante}`;
                        comprobanteHtml = `<div style='margin:10px 0'><b>Comprobante:</b><br><img src="${url}" alt="Comprobante" style="max-width:220px;max-height:220px;border-radius:8px;box-shadow:0 0 8px #00fff7;cursor:pointer" onclick="verImagenModal('${url}')"></div>`;
                    }
                    div.innerHTML = `
                        <b>Cliente:</b> ${compra.titular || compra.nombre} <br>
                        <b>Email:</b> ${compra.correo || compra.email} <br>
                        <b>Teléfono:</b> ${compra.telefono || ''} <br>
                        <b>Números:</b> ${Array.isArray(compra.numerosSeleccionados) ? compra.numerosSeleccionados.join(', ') : ''} <br>
                        <b>Monto:</b> $${compra.monto || (Array.isArray(compra.numerosSeleccionados) ? compra.numerosSeleccionados.length * 5 : '')} <br>
                        ${comprobanteHtml}
                        <button class='btn-menu' onclick='confirmarCompra(${compra._id})'>Confirmar y Enviar Correo</button>
                        <button class='btn-menu btn-danger' onclick='liberarCompra(${compra._id})'>Liberar</button>
                    `;
                    cont.appendChild(div);
                });
            }
            // Confirmadas
            if (confirmadas.length === 0) {
                contConfirmadas.innerHTML = '<span style="color:gray">No hay compras confirmadas.</span>';
            } else {
                contConfirmadas.innerHTML = '';
                confirmadas.forEach(compra => {
                    const div = document.createElement('div');
                    div.className = 'compra-pendiente';
                    let comprobanteHtml = '';
                    if (compra.comprobante) {
                        const url = `https://rifasvenezuela.onrender.com/uploads/${compra.comprobante}`;
                        comprobanteHtml = `<div style='margin:10px 0'><b>Comprobante:</b><br><img src="${url}" alt="Comprobante" style="max-width:220px;max-height:220px;border-radius:8px;box-shadow:0 0 8px #00fff7;cursor:pointer" onclick="verImagenModal('${url}')"></div>`;
                    }
                    div.innerHTML = `
                        <b>Cliente:</b> ${compra.titular || compra.nombre} <br>
                        <b>Email:</b> ${compra.correo || compra.email} <br>
                        <b>Teléfono:</b> ${compra.telefono || ''} <br>
                        <b>Números:</b> ${Array.isArray(compra.numerosSeleccionados) ? compra.numerosSeleccionados.join(', ') : ''} <br>
                        <b>Monto:</b> $${compra.monto || (Array.isArray(compra.numerosSeleccionados) ? compra.numerosSeleccionados.length * 5 : '')} <br>
                        ${comprobanteHtml}
                        <span style='color:#00fff7;font-weight:bold;'>Confirmado</span>
                    `;
                    contConfirmadas.appendChild(div);
                });
            }
        } catch {
            cont.innerHTML = '<span style="color:red">Error al cargar compras pendientes.</span>';
            contConfirmadas.innerHTML = '<span style="color:red">Error al cargar compras confirmadas.</span>';
        }
    }
    window.confirmarCompra = async function(id) {
        if (!confirm('¿Confirmar el pago y enviar correo al cliente?')) return;
        try {
            const res = await fetch('https://rifasvenezuela.onrender.com/api/confirmar', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({id})
            });
            if (res.ok) {
                alert('Compra confirmada y correo enviado.');
                cargarComprasPendientes();
                cargarDatosAdmin();
            } else {
                alert('Error al confirmar la compra.');
            }
        } catch {
            alert('Error de conexión al confirmar la compra.');
        }
    }
    window.liberarCompra = async function(id) {
        if (!confirm('¿Liberar esta compra? Los números volverán a estar disponibles.')) return;
        try {
            const res = await fetch('https://rifasvenezuela.onrender.com/api/liberar', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({id})
            });
            if (res.ok) {
                alert('Compra liberada.');
                cargarComprasPendientes();
                cargarDatosAdmin();
            } else {
                alert('Error al liberar la compra.');
            }
        } catch {
            alert('Error de conexión al liberar la compra.');
        }
    }
    // Modal para ver imagen grande
    window.verImagenModal = function(url) {
        document.getElementById('imgModal').src = url;
        document.getElementById('modalImg').classList.add('active');
    }
    document.getElementById('cerrarModal').onclick = function() {
        document.getElementById('modalImg').classList.remove('active');
        document.getElementById('imgModal').src = '';
    }
    document.getElementById('modalImg').onclick = function(e) {
        if (e.target === this) {
            this.classList.remove('active');
            document.getElementById('imgModal').src = '';
        }
    }
    // Botón para exportar historial CSV
    document.getElementById('exportarHistorialBtn').onclick = function() {
        fetch('https://rifasvenezuela.onrender.com/api/exportar-historial')
            .then(resp => {
                if (!resp.ok) throw new Error('No se pudo exportar el historial.');
                return resp.blob();
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'historial_rifa.csv';
                document.body.appendChild(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(url);
            })
            .catch(() => alert('No se pudo exportar el historial.'));
    };
    </script>
</body>
</html>
