<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pago de Rifa</title>
    <link rel="stylesheet" href="styles.css">
    <style>
    body { background: #10101a; min-height: 100vh; }
    .container { background: #131326; border-radius: 24px; box-shadow: 0 0 24px #00fff7, 0 0 8px #1a2980; margin: 40px auto; max-width: 600px; padding: 40px 30px; }
    .titulo { color: #00fff7; text-shadow: 0 0 8px #00fff7; font-family: 'Orbitron', Arial, sans-serif; font-size: 2.2em; text-align: center; margin-bottom: 24px; }
    .pago-resumen { color: #fff; text-align: center; margin-bottom: 18px; }
    .pago-form { display: flex; flex-direction: column; gap: 16px; }
    .pago-form label { color: #fff; font-weight: bold; }
    .pago-form input { padding: 10px; border-radius: 8px; border: none; background: #18182c; color: #00fff7; font-size: 1em; }
    .btn-menu { background: linear-gradient(90deg, #00fff7 0%, #1a2980 100%); color: #10101a; font-weight: bold; border: none; border-radius: 10px; padding: 12px 28px; font-size: 1.1em; box-shadow: 0 0 8px #00fff7; cursor: pointer; transition: background 0.2s, color 0.2s; }
    .btn-menu:hover { background: linear-gradient(90deg, #1a2980 0%, #00fff7 100%); color: #fff; }
    .conversion-info { color: #fff; text-align: center; margin-bottom: 12px; }
    .volver { margin-top: 18px; display: block; width: fit-content; margin-left: auto; margin-right: auto; }
    .popup-confirm {
        display:none;position:fixed;z-index:1000;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.85);justify-content:center;align-items:center;
    }
    .popup-confirm.active {display:flex;}
    .popup-confirm .popup-box {
        background:#131326;padding:36px 28px;border-radius:18px;box-shadow:0 0 24px #00fff7,0 0 8px #1a2980;
        color:#fff;max-width:400px;text-align:center;font-size:1.2em;
    }
    .popup-confirm .btn-menu {margin-top:18px;}
    </style>
</head>
<body>
    <div class="container">
        <h1 class="titulo">Pago de tu Rifa</h1>
        <div id="resumenPago" class="pago-resumen"></div>
        <form id="formPago" class="pago-form" enctype="multipart/form-data">
            <label for="nombre">Nombre completo:</label>
            <input type="text" id="nombre" required>
            <label for="cedula">Cédula o ID:</label>
            <input type="text" id="cedula" required>
            <label for="banco">Banco desde el que transfiere:</label>
            <input type="text" id="banco" required>
            <label for="email">Correo electrónico:</label>
            <input type="email" id="email" required>
            <label for="telefono">Teléfono:</label>
            <input type="tel" id="telefono" required>
            <label for="ubicacion">¿Desde dónde nos compras?</label>
            <input type="text" id="ubicacion" required placeholder="Ciudad, Estado o País">
            <label for="comprobante">Comprobante de pago:</label>
            <input type="file" id="comprobante" accept="image/*,application/pdf" required>
            <div id="conversion" class="conversion-info"></div>
            <button type="submit" class="btn-menu">Pagar</button>
        </form>
        <a href="seleccion.html" class="btn-menu volver">Volver a Selección</a>
    </div>
    <div class="popup-confirm" id="popupConfirm">
        <div class="popup-box">
            <b>¡Sus Boletos Han Sido Apartados!</b><br><br>
            Le enviaremos un correo al confirmar su pago.<br>
            Nuestro equipo trabaja lo más rápido que puede.<br>
            <span style="color:#00fff7">Agradecemos su confianza y paciencia.</span>
            <button class="btn-menu" onclick="window.location.href='index.html'">Aceptar</button>
        </div>
    </div>
    <script>
    // Mostrar resumen de selección
    const resumen = document.getElementById('resumenPago');
    const seleccion = localStorage.getItem('numerosSeleccionados');
    let cantidad = 0;
    let numerosSeleccionados = '';
    if (seleccion) {
        const arr = seleccion.split(',').map(x=>parseInt(x));
        cantidad = arr.length;
        numerosSeleccionados = arr.join(',');
        resumen.textContent = 'Números seleccionados: ' + arr.join(', ');
    } else {
        resumen.textContent = 'No hay números seleccionados.';
    }
    // Consultar tasa BCV y mostrar conversión
    async function mostrarConversion() {
        const div = document.getElementById('conversion');
        div.textContent = 'Consultando tasa BCV...';
        try {
            const res = await fetch('https://rifasvenezuela.onrender.com/api/tasa-bcv');
            const data = await res.json();
            const tasa = data.tasaBCV || data.tasa;
            if (!tasa) throw new Error('Sin tasa');
            const montoUSD = cantidad * 5;
            const montoBs = (montoUSD * tasa).toLocaleString('es-VE', {style:'currency', currency:'VES', maximumFractionDigits:2});
            div.innerHTML = `<b>Total a pagar:</b> $${montoUSD} = <span style='color:gold'>${montoBs} Bs</span> <br><small>Tasa BCV: ${tasa} Bs/USD</small>`;
        } catch {
            div.innerHTML = '<span style="color:red">No se pudo consultar la tasa BCV. Intente más tarde.</span>';
        }
    }
    mostrarConversion();
    // Envío real del formulario
    document.getElementById('formPago').addEventListener('submit', async function(e) {
        e.preventDefault();
        const nombre = document.getElementById('nombre').value.trim();
        const cedula = document.getElementById('cedula').value.trim();
        const banco = document.getElementById('banco').value.trim();
        const email = document.getElementById('email').value.trim();
        const telefono = document.getElementById('telefono').value.trim();
        const ubicacion = document.getElementById('ubicacion').value.trim();
        const comprobante = document.getElementById('comprobante').files[0];
        if (!nombre || !cedula || !banco || !email || !telefono || !ubicacion || !comprobante || !numerosSeleccionados) {
            alert('Por favor, complete todos los campos y seleccione sus números.');
            return;
        }
        const formData = new FormData();
        formData.append('titular', nombre);
        formData.append('cedula', cedula);
        formData.append('banco', banco);
        formData.append('correo', email);
        formData.append('telefono', telefono);
        formData.append('ubicacion', ubicacion);
        formData.append('comprobante', comprobante);
        formData.append('numerosSeleccionados', numerosSeleccionados);
        try {
            const res = await fetch('https://rifasvenezuela.onrender.com/api/pago', {
                method: 'POST',
                body: formData
            });
            if (res.ok) {
                document.getElementById('popupConfirm').classList.add('active');
                localStorage.removeItem('numerosSeleccionados');
            } else {
                const data = await res.json();
                alert(data.error || 'Error al registrar el pago.');
            }
        } catch {
            alert('Error de conexión al registrar el pago.');
        }
    });
    </script>
</body>
</html>
