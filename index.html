<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Selecciona tus Números de Rifa</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .btn-continuar {
            margin-top: 20px;
            background: linear-gradient(90deg, #00fff7, #1a2980);
            color: #222;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-size: 1.1em;
            cursor: pointer;
            box-shadow: 0 0 10px #00fff7;
            transition: background 0.3s;
        }
        .btn-continuar:hover {
            background: linear-gradient(90deg, #1a2980, #00fff7);
        }
        .modal-venta-cerrada {
            position: fixed;
            z-index: 9999;
            left: 0; top: 0; width: 100vw; height: 100vh;
            background: rgba(10,30,50,0.85);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: linear-gradient(135deg, #16222A 0%, #3A6073 100%);
            color: #fff;
            border-radius: 18px;
            box-shadow: 0 0 32px #00fff7, 0 0 8px #1a2980;
            padding: 38px 32px 28px 32px;
            text-align: center;
            max-width: 350px;
            width: 90vw;
            position: relative;
        }
        .modal-content h2 {
            color: #00fff7;
            margin-bottom: 12px;
        }
        .modal-content p {
            font-size: 1.15em;
        }
        .close-modal {
            position: absolute;
            top: 10px;
            right: 18px;
            font-size: 2em;
            color: #00fff7;
            cursor: pointer;
            font-weight: bold;
        }
        .close-modal:hover {
            color: #fff;
        }
        .suerte-row {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 16px;
            margin-bottom: 18px;
        }
        .suerte-row label {
            margin-bottom: 0;
            font-size: 1.08em;
        }
        .suerte-row input[type="number"] {
            width: 70px;
            padding: 8px;
            border-radius: 7px;
            border: none;
            background: #1a2633;
            color: #e3eaf2;
            font-size: 1em;
            text-align: center;
        }
        .calculo-precio-box {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 18px;
            background: rgba(0,255,247,0.07);
            border-radius: 10px;
            padding: 10px 12px 6px 12px;
            box-shadow: 0 0 10px #00fff7 inset;
        }
        .calculo-precio-box label {
            color: #00fff7;
            font-weight: 500;
        }
        #totalBox {
            color: #fff;
            font-weight: bold;
            margin-left: 18px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Selecciona tus Números de Rifa</h1>
        <p class="precio-info">Cada número tiene un costo de <strong>$5</strong></p>
        <div class="suerte-row">
            <label for="cantidad">Cantidad de números a comprar:</label>
            <input type="number" id="cantidad" min="1" max="1000" value="1">
            <button type="button" id="suerteBtn" class="btn-continuar">Me siento con suerte</button>
        </div>
        <div style="display:flex;justify-content:center;margin-bottom:18px;">
            <button class="btn-continuar" id="continuarBtnTop">Continuar al Pago</button>
        </div>
        <div id="numerosRifa" class="numeros-rifa"></div>
        <div id="seleccionados" class="seleccionados"></div>
        <div style="display:flex;justify-content:center;margin-top:18px;">
            <button class="btn-continuar" id="continuarBtn">Continuar al Pago</button>
        </div>
        <div class="calculo-precio-box">
            <span style="color:#00fff7;font-weight:500;">Precio por boleto ($): <span id="precioBoletoFijo">5</span></span>
            <label style="margin-left:18px;">Tasa BCV (Bs/USD): <input type="number" id="tasaBCV" min="0.01" step="0.0001" value="..." style="width:100px;" readonly></label>
            <div id="totalBox" style="margin-top:10px;font-size:1.15em;"></div>
        </div>
        <div id="ventaCerradaModal" class="modal-venta-cerrada" style="display:none;">
            <div class="modal-content">
                <span class="close-modal" id="cerrarModalVenta">&times;</span>
                <h2>Venta Cerrada</h2>
                <p>La venta de boletos está cerrada. Espere la próxima rifa.</p>
            </div>
        </div>
    </div>
    <script>
        const totalNumeros = 1000;
        const numerosRifa = document.getElementById('numerosRifa');
        const seleccionados = new Set();
        let vendidos = [];
        let ventaActiva = true;

        async function verificarVentaActiva() {
            try {
                const res = await fetch('http://localhost:3000/api/venta-activa');
                const data = await res.json();
                ventaActiva = !!data.ventaActiva;
                if (!ventaActiva) {
                    document.getElementById('ventaCerradaModal').style.display = 'flex';
                    document.querySelectorAll('.btn-continuar, #suerteBtn, #cantidad').forEach(el => el.disabled = true);
                }
            } catch {}
        }

        async function cargarNumerosVendidos() {
            await verificarVentaActiva();
            try {
                const res = await fetch('http://localhost:3000/api/numeros-vendidos');
                vendidos = await res.json();
            } catch {}
            renderNumeros();
        }

        function renderNumeros() {
            numerosRifa.innerHTML = '';
            for (let i = 1; i <= totalNumeros; i++) {
                const btn = document.createElement('div');
                btn.className = 'numero-rifa';
                btn.textContent = i;
                if (vendidos.includes(i)) {
                    btn.classList.add('vendido');
                    btn.style.background = '#444';
                    btn.style.color = '#888';
                    btn.style.cursor = 'not-allowed';
                    btn.title = 'Vendido';
                } else {
                    btn.addEventListener('click', () => {
                        if (seleccionados.has(i)) {
                            seleccionados.delete(i);
                            btn.classList.remove('selected');
                        } else {
                            seleccionados.add(i);
                            btn.classList.add('selected');
                        }
                        mostrarSeleccionados();
                    });
                }
                numerosRifa.appendChild(btn);
            }
        }

        const PRECIO_BOLETO = 5; // Precio fijo del boleto en dólares (solo modificable en el código)
        async function obtenerTasaBCV() {
            try {
                const res = await fetch('http://localhost:3000/api/tasa-bcv');
                const data = await res.json();
                if (data.tasaBCV) {
                    document.getElementById('tasaBCV').value = data.tasaBCV;
                }
            } catch {}
            actualizarTotales();
        }
        function actualizarTotales() {
            const tasa = parseFloat(document.getElementById('tasaBCV').value) || 1;
            const cantidad = seleccionados.size;
            const totalUSD = (PRECIO_BOLETO * cantidad).toFixed(2);
            const totalBs = (PRECIO_BOLETO * cantidad * tasa).toFixed(2);
            document.getElementById('totalBox').innerHTML = `Total: <span style=\"color:#00fff7;\">$${totalUSD}</span> | <span style=\"color:#ffd600;\">Bs ${totalBs}</span>`;
            document.getElementById('precioBoletoFijo').textContent = PRECIO_BOLETO;
        }

        function mostrarSeleccionados() {
            const arr = Array.from(seleccionados).sort((a, b) => a - b);
            document.getElementById('seleccionados').textContent = arr.length > 0 ? 'Números seleccionados: ' + arr.join(', ') : '';
            actualizarTotales();
        }

        // Ambos botones llevan al pago
        function continuarAlPago() {
            if (seleccionados.size === 0) {
                alert('Debes seleccionar al menos un número de rifa.');
                return;
            }
            const arr = Array.from(seleccionados).sort((a, b) => a - b);
            localStorage.setItem('numerosSeleccionados', arr.join(','));
            window.location.href = 'pago.html';
        }
        document.getElementById('continuarBtn').addEventListener('click', continuarAlPago);
        document.getElementById('continuarBtnTop').addEventListener('click', continuarAlPago);

        document.getElementById('suerteBtn').addEventListener('click', function() {
            const cantidad = parseInt(document.getElementById('cantidad').value) || 1;
            // Buscar disponibles
            const disponibles = [];
            for (let i = 1; i <= totalNumeros; i++) {
                if (!vendidos.includes(i) && !seleccionados.has(i)) disponibles.push(i);
            }
            if (cantidad > disponibles.length) {
                alert('No hay suficientes números disponibles.');
                return;
            }
            // Limpiar selección actual
            seleccionados.clear();
            // Elegir aleatorios
            for (let i = 0; i < cantidad; i++) {
                const idx = Math.floor(Math.random() * disponibles.length);
                seleccionados.add(disponibles[idx]);
                disponibles.splice(idx, 1);
            }
            mostrarSeleccionados();
            renderNumeros();
        });

        // Cerrar modal
        document.getElementById('cerrarModalVenta').onclick = function() {
            document.getElementById('ventaCerradaModal').style.display = 'none';
        };

    cargarNumerosVendidos();
    setInterval(cargarNumerosVendidos, 5000);
    window.addEventListener('DOMContentLoaded', obtenerTasaBCV);
    </script>
</body>
</html>
